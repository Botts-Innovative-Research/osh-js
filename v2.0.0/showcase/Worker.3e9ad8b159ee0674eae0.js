!function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);Math.pow(2,53);function s(e){return null!=e}function i(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var o=class{buildUrl(e){let t="";t+=e.protocol+"://",t+=e.endpointUrl+"?",t+="service="+e.service+"&",t+="version=2.0&",t+="request=GetResult&",t+="offering="+e.offeringID+"&",e.foiURN&&""!==e.foiURN&&(t+="featureOfInterest="+e.foiURN+"&"),t+="observedProperty="+e.observedProperty+"&";const n=s(e.lastTimeStamp)?e.lastTimeStamp:e.startTime;return this.lastStartTime=e.startTime,t+="temporalFilter=phenomenonTime,"+n+"/"+e.endTime+"&",e.replaySpeed&&(t+="replaySpeed="+e.replaySpeed),e.responseFormat&&(t+="&responseFormat="+e.responseFormat),t}};var r=class extends o{parseTimeStamp(e){let t=String.fromCharCode.apply(null,new Uint8Array(e));return new Date(JSON.parse(t).time).getTime()}parseData(e){let t=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e))),n={};for(let e in t)"time"!==e&&(n[e]=t[e]);return n}buildUrl(e){let t="";t+=e.protocol+"://",t+=e.endpointUrl+"?",t+="service="+e.service+"&",t+="version=2.0&",t+="request=GetResult&",t+="offering="+e.offeringID+"&",e.foiURN&&""!==e.foiURN&&(t+="featureOfInterest="+e.foiURN+"&"),t+="observedProperty="+e.observedProperty+"&";let n=e.startTime,s=e.endTime;return"now"!==n&&0!==e.timeShift&&"urn:android:device:060693280a28e015-sos"!==e.offeringID&&(n=new Date(Date.parse(n)-e.timeShift).toISOString(),s=new Date(Date.parse(s)-e.timeShift).toISOString()),t+="temporalFilter=phenomenonTime,"+n+"/"+s+"&",e.replaySpeed&&(t+="replaySpeed="+e.replaySpeed),t+="&responseFormat=application/json",t}};var c=class{constructor(e){this.url=e,this.id="DataConnector-"+i(),this.reconnectTimeout=12e4}setUrl(e){this.url=e}getId(){return this.id}getUrl(){return this.url}setReconnectTimeout(e){this.reconnectTimeout=e}onReconnect(){}disconnect(){}};var a=class extends c{constructor(e){super(e),this.interval=-1,this.lastReceiveTime=-1}connect(){this.init||(this.init=!0,this.ws=new WebSocket(this.getUrl()),this.ws.binaryType="arraybuffer",this.ws.onmessage=function(e){this.lastReceiveTime=Date.now(),e.data.byteLength>0&&this.onMessage(e.data)}.bind(this),this.ws.onerror=function(e){console.error("WebSocket stream error: "+e),this.ws.close(),this.init=!1,this.lastReceiveTime=-1}.bind(this),-1===this.interval&&(this.interval=setInterval(function(){let e=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||e>=this.reconnectTimeout)&&(console.warn(`trying to reconnect after ${this.reconnectTimeout} ..`),this.reconnect())}.bind(this),this.reconnectTimeout)))}disconnect(){this.fullDisconnect(!0)}fullDisconnect(e){null!=this.ws&&(this.ws.close(),this.init=!1),e&&clearInterval(this.interval)}reconnect(){this.onReconnect(),this.init&&this.fullDisconnect(!1),this.connect()}onMessage(e){}close(){this.disconnect()}};var l=class extends c{constructor(e,t){super(e),this.method="POST",this.responseType="arraybuffer",s(t)&&(t.method&&(this.method=t.method),t.responseType&&(this.responseType=t.responseType))}sendRequest(e,t){let n=this,i=new XMLHttpRequest;i.timeout=6e4,null===e?(s(t)?i.open("GET",this.getUrl()+"?"+t,!0):i.open("GET",this.getUrl(),!0),i.responseType=this.responseType,i.onload=e=>{i.response&&n.onMessage(i.response)},i.ontimeout=e=>{console.log("Timeout")},i.send(null)):(i.open("POST",this.getUrl(),!0),i.setRequestHeader("Content-Type","text/xml"),i.send(e),i.onreadystatechange=()=>{i.readyState<4||4===i.readyState&&(200===i.status&&i.status<300?n.onSuccess(i.responseText):n.onError(""))})}onError(e){}onSuccess(e){}connect(){this.sendRequest(null)}};var h=class extends c{constructor(e){super(e),this.lastReceiveTime=-1,this.interval=-1,this.broadcastChannel=null}connect(){null===this.broadcastChannel&&(this.broadcastChannel=new BroadcastChannel(this.getUrl()),this.broadcastChannel.onmessage=e=>{this.lastReceiveTime=Date.now(),this.onMessage(e.data.data)},this.broadcastChannel.onerror=e=>{console.error("BroadcastChannel stream error: "+e),this.broadcastChannel.close(),this.init=!1,this.lastReceiveTime=-1},-1===this.interval&&(this.interval=setInterval(function(){let e=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||e>=this.reconnectTimeout)&&(console.warn(`trying to reconnect after ${this.reconnectTimeout} ..`),this.reconnect())}.bind(this),this.reconnectTimeout)))}disconnect(){this.fullDisconnect(!0)}fullDisconnect(e){null!=this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),e&&clearInterval(this.interval)}reconnect(){this.onReconnect(),this.init&&this.fullDisconnect(!1),this.connect()}onMessage(e){}close(){this.disconnect()}};const u=new class{constructor(e){this.parser=e,this.connector=null,this.lastTimeStamp=null,this.lastStartTime="now",this.timeShift=0,this.reconnectTimeout=1e4,this.connected=!1}createConnector(e,t,n){this.dataSourceId=n,null!==this.connector&&(this.connector.disconnect(),this.connector=null),this.broadcastChannel=new BroadcastChannel(t);const i=JSON.parse(e);s(i.timeShift)&&(this.timeShift=i.timeShift),s(i.bufferingTime)&&(this.bufferingTime=i.bufferingTime),s(i.timeOut)&&(this.timeOut=i.timeOut),s(i.reconnectTimeout)&&(this.reconnectTimeout=i.reconnectTimeout),this.properties=i,this.createDataConnector(i)}createDataConnector(e){const t=this.parser.buildUrl({...e,timeShift:this.timeShift});e.protocol.startsWith("ws")?(this.connector=new a(t),this.connector.onMessage=this.onMessage.bind(this),this.connector.setReconnectTimeout(this.reconnectTimeout)):e.protocol.startsWith("http")?(this.connector=new l(t),this.connector.responseType="arraybuffer",this.connector.onMessage=this.onMessage.bind(this),this.connector.setReconnectTimeout(this.reconnectTimeout)):e.protocol.startsWith("topic")&&(this.connector=new h(t),this.connector.onMessage=this.onMessage.bind(this),this.connector.setReconnectTimeout(this.reconnectTimeout));const n=this.parser.lastStartTime;null!==this.connector&&(this.connector.onReconnect=()=>{"now"!==n&&this.connector.setUrl(this.parser.buildUrl({lastTimeStamp:new Date(this.lastTimeStamp).toISOString(),...this.properties}))})}setTopic(e){null!==this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(e),this.topic=e}connect(){null!==this.connector&&this.connector.connect()}disconnect(){null!==this.connector&&this.connector.disconnect()}onMessage(e){const t={dataSourceId:this.dataSourceId,timeStamp:this.parser.parseTimeStamp(e)+this.timeShift,data:this.parser.parseData(e)};this.lastTimeStamp=t.timeStamp,this.broadcastChannel.postMessage(t)}}(new r);function p(e){self.postMessage(e)}self.onmessage=e=>{"init"===e.data.message?(u.createConnector(e.data.properties,e.data.topic,e.data.id),u.onData=p):"connect"===e.data.message?u.connect():"disconnect"===e.data.message?u.disconnect():"topic"===e.data.message&&u.setTopic(e.data.topic)}}]);