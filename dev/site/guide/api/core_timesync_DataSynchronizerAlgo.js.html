<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/timesync/DataSynchronizerAlgo.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>
<div class="container">
    <div id="main">

        <h1 class="page-title">Source: core/timesync/DataSynchronizerAlgo.js</h1>

        



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {isDefined} from "../utils/Utils.js";
import {Status} from "../connector/Status.js";

class DataSynchronizerAlgo {
    constructor(dataSources, timerResolution = 5) {
        this.dataSourceMap = {};
        this.tsRun = undefined;
        this.timerResolution = timerResolution;
        this.interval = null;
        this.datasources = [];
        for (let ds of dataSources) {
            this.addDataSource(ds);
        }
    }

    removeDataSource(dataSourceId) {
        this.datasources = this.datasources.filter( elt => elt.id !== dataSourceId);
        delete this.dataSourceMap[dataSourceId];
    }

    push(dataSourceId, dataBlocks) {
    }

    getCurrentTimestamp() {
        return this.tsRun;
    }

    processData() {
        let tsRef = -1;
        let clockTimeRef = performance.now();

        // get reference start timestamp
        // the reference start timestamp should the oldest one
        let currentDs;
        for (let currentDsId in this.dataSourceMap) {
            currentDs = this.dataSourceMap[currentDsId];
            if (currentDs.dataBuffer.length > 0) {
                tsRef = (tsRef === -1 || currentDs.dataBuffer[0].data.timestamp &lt; tsRef) ? currentDs.dataBuffer[0].data.timestamp :
                    tsRef;
            }
        }

        this.interval = setInterval(() => {
            // 1) return the oldest data if any
            while (this.computeNextData(tsRef, clockTimeRef)) ;

        }, this.timerResolution);
        console.warn(`Started Algorithm with  tsRef=${new Date(tsRef).toISOString()}`);
    }

    /**
     * Compute the next data if any. We return only 1 value for this iteration. If there are multiple values to return,
     * we return only the oldest one.
     * @param tsRef - the timestamp of the first data
     * @param refClockTime - the absolute diff time really spent
     */
    computeNextData(tsRef, refClockTime) {
        throw Error('Should be overridden');
    }

    /**
     * Add dataSource to be synchronized
     * @param {Datasource} dataSource - the dataSource to synchronize
     */
    addDataSource(dataSource) {
        throw Error('Should be overridden');
    }

    checkVersion(datasource, dataBlock) {
        throw Error('Should be overridden');
    }

    onData(dataSourceId, dataBlock) {
    }

    checkStart() {}

    /**
     * Change the dataSource status
     * @param {Status} status - the new status
     * @param {String} dataSourceId - the corresponding dataSource id
     */
    setStatus(dataSourceId, status) {
        throw Error('Should be overridden');
    }

    close() {
        if (isDefined(this.interval)) {
            clearInterval(this.interval);
            this.interval = undefined;
        }
        console.log("Data synchronizer terminated successfully");
    }

    onStart()  {}
}

export default DataSynchronizerAlgo;
</code></pre>
        </article>
    </section>




    </div>
</div>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
