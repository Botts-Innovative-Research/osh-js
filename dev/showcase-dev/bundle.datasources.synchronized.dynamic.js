!function(e){var t={};function s(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(i,a,function(t){return e[t]}.bind(null,a));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=2)}([function(e,t,s){e.exports=function(){return new Worker(s.p+"WorkerName.8a534e053ba2ee68c6e5.js")}},function(e,t,s){e.exports=function(){return new Worker(s.p+"WorkerName.096c9b864e3f29be949a.js")}},function(e,t,s){"use strict";s.r(t);const i="data",a="last-time",r="master-time",n=document.getElementById("datasource-gps"),o=document.getElementById("datasource-orientation"),c=document.getElementById("datasource-video"),d=document.getElementById("error"),m=document.getElementById("last-gps"),p=document.getElementById("last-orient"),h=document.getElementById("last-video"),u=document.getElementById("last-time"),l=document.getElementById("master-time");let g,y;Math.pow(2,53);function S(e){return null!=e}function T(e,t="letiable"){if(!S(e))throw t+" must be defined";return e}function f(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var w=s(0),M=s.n(w);const b="replay",v="realTime";var I=class{constructor(e,t){this.id=t.id||"DataSource-"+f(),this.name=e,this.properties=t,this.eventSubscriptionMap={},this.init=void 0,this.messagesMap={},this.mode=v,S(t.mode)&&(this.mode=t.mode)}getId(){return this.id}getName(){return this.name}terminate(){null!==this.dataSourceWorker&&this.dataSourceWorker.terminate()}getTopicId(){return"datasource-data-"+this.id}getVersion(){return 0}subscribe(e,t){for(let s=0;s<t.length;s++)t[s]in this.eventSubscriptionMap||(this.eventSubscriptionMap[t[s]]=[]),this.eventSubscriptionMap[t[s]].push(e)}async createWorker(e){return new M.a}async updateProperties(e){return this.properties={...this.properties,...e},new Promise(t=>{this.postMessage({message:"update-properties",data:e},t)})}async connect(){await this.checkInit(),await this.doConnect()}async initDataSource(){return new Promise(async(e,t)=>{this.dataSourceWorker=await this.createWorker(this.properties),this.handleWorkerMessage(),this.postMessage({message:"init",id:this.id,properties:this.properties,topics:{data:this.getTopicId()}},async t=>{new BroadcastChannel(this.getTopicId()).onmessage=async e=>{await this.handleMessage(e)},e(t)})})}async handleMessage(e){const t=e.data.type;if(t in this.eventSubscriptionMap)for(let s=0;s<this.eventSubscriptionMap[t].length;s++)this.eventSubscriptionMap[t][s](e.data)}async checkInit(){return new Promise(async(e,t)=>{S(this.init)||(this.init=this.initDataSource()),await this.init,e()})}async doConnect(){return new Promise(async e=>{this.postMessage({message:"connect"},e)})}async isConnected(){return new Promise(async e=>{await this.checkInit(),this.postMessage({message:"is-connected"},e)})}async disconnect(){return new Promise(async e=>{await this.checkInit(),this.postMessage({message:"disconnect"},e)})}postMessage(e,t){const s=f();this.dataSourceWorker.postMessage({...e,messageId:s}),S(t)&&(this.messagesMap[s]=t)}handleWorkerMessage(){this.dataSourceWorker.onmessage=e=>{const t=e.data.messageId;t in this.messagesMap&&(this.messagesMap[t](e.data.data),delete this.messagesMap[t])}}async onDisconnect(){}reset(){}};var x=class extends I{constructor(e,t){super(e,t),"minTime"in t||this.setMinTime(t.startTime),"maxTime"in t||this.setMaxTime(t.endTime),T(t,"Some properties must be defined"),this.dataSynchronizer=void 0}getTimeTopicId(){return"datasource-time-"+this.id}getStartTime(){return this.properties.startTime}getMode(){return this.properties.mode}getEndTime(){return this.properties.endTime}getMinTime(){return this.properties.minTime}getMaxTime(){return this.properties.maxTime}setMinTime(e){this.properties.minTime=e}setMaxTime(e){this.properties.maxTime=e}getReplaySpeed(){return this.properties.replaySpeed}setReplaySpeed(e){this.properties.replaySpeed=e}async setDataSynchronizer(e){return new Promise(async(t,s)=>{await this.checkInit();const i="data-synchronizer-"+e.id;this.dataSynchronizer=e,this.postMessage({message:"topics",topics:{data:i,time:this.getTimeTopicId(),sync:e.getTimeTopicId()}},t)})}async disconnect(){return new Promise(async e=>{await this.checkInit(),this.postMessage({message:"disconnect"},e)})}async doConnect(){return new Promise(async e=>{let t=this.properties.startTime;if(S(this.dataSynchronizer)){let e=(await this.dataSynchronizer.getCurrentTime()).data;S(e)&&(t=new Date(e).toISOString())}this.postMessage({message:"connect",startTime:t},e)})}async initDataSource(e){return await super.initDataSource(e),new Promise(async(e,t)=>{this.postMessage({message:"topics",topics:{data:this.getTopicId(),time:this.getTimeTopicId()}},async()=>{new BroadcastChannel(this.getTimeTopicId()).onmessage=async e=>{await this.handleTimeMessage(e)},e()})})}async handleTimeMessage(e){const t=e.data.type;if(t in this.eventSubscriptionMap)for(let s=0;s<this.eventSubscriptionMap[t].length;s++)this.eventSubscriptionMap[t][s](e.data)}async setTimeRange(e=this.getStartTime(),t=this.getEndTime(),s=this.getReplaySpeed(),i=!1,a=this.getMode()){let r=e,n=t;if(a!==v){let s=new Date(e).getTime()-new Date(this.getMinTime()).getTime(),i=new Date(this.getMaxTime()).getTime()-new Date(t).getTime();if(s<0&&i<0)return;r=s<0?this.getMinTime():e,n=i<0?this.getMaxTime():t}return this.updateProperties({startTime:r,endTime:n,replaySpeed:s,reconnect:i,mode:a})}};var D=class extends x{constructor(e,t){super(e,{protocol:"ws",service:"SOS",timeShift:0,reconnectTimeout:5e3,reconnectRetry:10,tls:!1,type:"SosGetResult",mode:v,prefetchBatchSize:250,prefetchBatchDuration:5e3,...t})}},k=s(1),P=s.n(k);var O=class{constructor(e){this.bufferingTime=1e3,this.currentTime=Date.now(),this.id=e.id||f(),this.dataSources=e.dataSources||[],this.replaySpeed=e.replaySpeed||1,this.timerResolution=e.timerResolution||5,this.masterTimeRefreshRate=e.masterTimeRefreshRate||250,this.mode=e.mode||b,this.initialized=!1,this.properties={},this.properties.replaySpeed=this.replaySpeed,this.eventSubscriptionMap={},this.messagesMap={},this.last={startTime:void 0,endTime:void 0,replaySpeed:1},this.mode!==v?(T(e.startTime,"startTime"),T(e.startTime,"endTime"),this.properties.startTime=e.startTime,this.properties.endTime=e.endTime):(this.properties.startTime="now",this.properties.endTime="2055-01-01Z")}getTopicId(){return"data-synchronizer-"+this.id}getTimeTopicId(){return"data-synchronizer-time-"+this.id}initEventSubscription(){new BroadcastChannel(this.getTopicId()).onmessage=e=>{const t=e.data.type;if(t in this.eventSubscriptionMap)for(let s=0;s<this.eventSubscriptionMap[t].length;s++)this.eventSubscriptionMap[t][s](e.data)},new BroadcastChannel(this.getTimeTopicId()).onmessage=e=>{const t=e.data.type;if(t in this.eventSubscriptionMap)for(let s=0;s<this.eventSubscriptionMap[t].length;s++)this.eventSubscriptionMap[t][s](e.data)}}getStartTime(){if(0===this.dataSources.length)throw"dataSource array is empty";let e=Number.MAX_VALUE;for(let t of this.dataSources){let s=new Date(t.getStartTime()).getTime();s<e&&(e=s)}return new Date(e).toISOString()}getEndTime(){if(0===this.dataSources.length)throw"dataSource array is empty";let e=Number.MIN_VALUE;for(let t of this.dataSources){let s=new Date(t.getEndTime()).getTime();s>e&&(e=s)}return new Date(e).toISOString()}getMinTime(){if(0===this.dataSources.length)throw"dataSource array is empty";let e=Number.MAX_VALUE;for(let t of this.dataSources){let s=new Date(t.getMinTime()).getTime();s<e&&(e=s)}return new Date(e).toISOString()}getMaxTime(){if(0===this.dataSources.length)throw"dataSource array is empty";let e=Number.MIN_VALUE;for(let t of this.dataSources){let s=new Date(t.getMaxTime()).getTime();s>e&&(e=s)}return new Date(e).toISOString()}setMinTime(e){for(let t of this.dataSources)t.setMinTime(e)}setMaxTime(e){for(let t of this.dataSources)t.setMaxTime(e)}getReplaySpeed(){return this.replaySpeed}terminate(){null!==this.synchronizerWorker&&(this.synchronizerWorker.terminate(),this.synchronizerWorker=null);for(let e of this.dataSources)e.terminate();this.lastTime={start:void 0,end:void 0}}subscribe(e,t){for(let s=0;s<t.length;s++)t[s]in this.eventSubscriptionMap||(this.eventSubscriptionMap[t[s]]=[]),this.eventSubscriptionMap[t[s]].push(e)}getMode(){return this.mode}async initDataSources(){return new Promise(async(e,t)=>{try{const t=[];let s=this.mode;for(let e of this.dataSources){const i=await this.createDataSourceForWorker(e);t.push(i),s=e.mode}this.synchronizerWorker=new P.a,this.handleWorkerMessage(),await this.postMessage({message:"init",dataSources:t,replaySpeed:this.replaySpeed,timerResolution:this.timerResolution,masterTimeRefreshRate:this.masterTimeRefreshRate,startTime:this.properties.startTime,endTime:this.properties.endTime,mode:s,topics:{data:this.getTopicId(),time:this.getTimeTopicId()}},function(){this.initEventSubscription(),this.initialized=!0,e()}.bind(this),!1)}catch(e){console.log(e),t(e)}})}async createDataSourceForWorker(e){const t={bufferingTime:e.properties.bufferingTime||0,timeOut:e.properties.timeOut||0,id:e.id,name:e.name,minTimestamp:new Date(e.getMinTime()).getTime(),maxTimestamp:new Date(e.getMaxTime()).getTime()};try{await e.setDataSynchronizer(this),e.properties.replaySpeed=this.replaySpeed}catch(e){throw console.error("Cannot set the synchronizer to this DataSource",e),e}return t}async addDataSource(e,t=!1){if(e.checkInit(),t)return new Promise(async t=>{const s=await this.createDataSourceForWorker(e);this.dataSources.push(e),await this.postMessage({message:"add",dataSources:[s]}),await e.connect(),t()});this.dataSources.push(e)}async removeDataSource(e,t=!1){if(t)return new Promise(async t=>{this.dataSources=this.dataSources.filter(t=>t.id!==e.getId()),await this.postMessage({message:"remove",dataSources:[e.getId()]}),await e.disconnect(),t()});this.dataSources=this.dataSources.filter(t=>t.id!==e.getId())}async push(e,t){return new Promise(async(s,i)=>{null!==this.synchronizerWorker&&await this.postMessage({type:"data",dataSourceId:e,data:t},s)})}async connect(){await this.checkInit(),await this.doConnect()}async checkInit(){const e=this;return new Promise(async(t,s)=>{S(e.init)||(e.init=e.initDataSources()),await e.init,t()})}async doConnect(){return new Promise(async e=>{if(this.last.startTime)await this.setTimeRange(this.last.startTime,this.last.endTime,this.last.replaySpeed,!0);else{for(let e of this.dataSources)await e.connect();await this.postMessage({message:"connect"},e)}})}async disconnect(){const e=(await this.getCurrentTime()).data;e&&(this.last.startTime=new Date(e).toISOString(),console.log("Saving lastTimestamp as "+this.last.startTime)),await this.reset();for(let e of this.dataSources)await e.disconnect()}async setReplaySpeed(e){return new Promise(async t=>{this.replaySpeed=e,this.last.replaySpeed=e,this.properties.replaySpeed=e,await this.postMessage({message:"replay-speed",replaySpeed:e},t)})}async setTimeRange(e=this.getStartTime(),t=this.getEndTime(),s=this.getReplaySpeed(),i=!1,a=this.mode){return new Promise(async r=>{this.last.startTime=e,this.last.endTime=t,this.last.replaySpeed=s,this.properties.startTime=e,this.properties.endTime=t,await this.postMessage({message:"update-properties",mode:a,replaySpeed:s,startTime:e,endTime:t},()=>{for(let r of this.dataSources)r.setTimeRange(e,t,s,i,a);this.mode=a,r()})})}async updateProperties(e){for(let t of this.dataSources)t.updateProperties(e)}async reset(){return new Promise(async e=>{await this.checkInit(),await this.postMessage({message:"reset"},e)})}async getCurrentTime(){return new Promise(async e=>{await this.postMessage({message:"current-time"},e)})}getLast(){return this.last.startTime?this.last:{startTime:this.getStartTime(),endTime:this.getEndTime(),replaySpeed:this.getReplaySpeed()}}async isConnected(){for(let e of this.dataSources)if(!await e.isConnected())return!1;return!0}async postMessage(e,t,s=!0){s&&await this.checkInit();const i=f();this.synchronizerWorker.postMessage({...e,messageId:i}),S(t)&&(this.messagesMap[i]=t)}handleWorkerMessage(){this.synchronizerWorker.onmessage=e=>{const t=e.data.messageId;t in this.messagesMap&&(this.messagesMap[t](e.data.data),delete this.messagesMap[t])}}};const R="2015-12-19T21:04:29.231Z",E="2015-12-19T21:06:59.675Z",W=new D("drone-Video",{endpointUrl:"sensiasoft.net/sensorhub/sos",offeringID:"urn:mysos:solo:video2",observedProperty:"http://sensorml.com/ont/swe/property/VideoFrame",startTime:R,endTime:E,mode:b,tls:!0}),z=new D("android-GPS",{endpointUrl:"sensiasoft.net/sensorhub/sos",offeringID:"urn:mysos:solo:nav2",observedProperty:"http://www.opengis.net/def/property/OGC/0/PlatformLocation",startTime:R,endTime:E,responseFormat:"application/json",mode:b,tls:!0}),B=new D("android-Heading",{endpointUrl:"sensiasoft.net/sensorhub/sos",offeringID:"urn:mysos:solo:nav2",observedProperty:"http://www.opengis.net/def/property/OGC/0/PlatformOrientation",startTime:R,endTime:E,mode:b,tls:!0}),C=new O({replaySpeed:5,timerResolution:5,startTime:R,endTime:E,masterTimeRefreshRate:25,dataSources:[]});W.subscribe(e=>function(e){let t;for(let s=0;s<e.length;s++)t=e[s],t.data.videoFrame.data=e[s].data.videoFrame.data.slice(0,10),c.value=JSON.stringify([t])+"\n";h.innerText=new Date(e[e.length-1].data.timestamp).toISOString()+" - Video"}(e.values),[i]),z.subscribe(e=>{return t=e.values,n.value=JSON.stringify(t),void(m.innerText=new Date(t[t.length-1].data.timestamp).toISOString()+" - Location");var t},[i]),B.subscribe(e=>{return t=e.values,o.value=JSON.stringify(t)+"\n",void(p.innerText=new Date(t[t.length-1].data.timestamp).toISOString()+" - Orientation");var t},[i]),C.subscribe(e=>function(e){if(e.type===r)g=e.timestamp;else{if(e.type!==a)return;y=e.timestamp,y<g&&(d.value=new Date(g).toISOString()+" < "+new Date(g).toISOString()+"\n")}}(e),[a,r]),C.subscribe(e=>{return t=e.timestamp,void(l.innerText=new Date(t).toISOString()+" - MasterTime");var t},[r]),C.subscribe(e=>{return t=e.timestamp,void(u.innerText=new Date(t).toISOString()+" - LastTime");var t},[a]),C.addDataSource(z),C.addDataSource(B),C.addDataSource(W),C.connect();const N=document.getElementById("connect-gps-button"),j=document.getElementById("disconnect-gps-button"),_=document.getElementById("connect-video-button"),L=document.getElementById("disconnect-video-button");N.onclick=()=>{z.connect()},j.onclick=()=>{z.disconnect()},_.onclick=()=>{W.connect()},L.onclick=()=>{W.disconnect()}}]);