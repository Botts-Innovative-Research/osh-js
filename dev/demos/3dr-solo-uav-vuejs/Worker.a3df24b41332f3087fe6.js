!function(e){var t={};function a(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(s,i,function(t){return e[t]}.bind(null,i));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t,a){"use strict";a.r(t);Math.pow(2,53);function s(e){return null!=e}const i="disconnected";var r=class{constructor(e,t=1,a=5){this.dataSourceMap={},this.bufferingTime=1e3,this.startBufferingTime=-1,this.tsRun=0,this.replaySpeed=t,this.timerResolution=a;let s=-1;for(let t of e)this.addDataSource(t),s=t.bufferingTime>s?t.bufferingTime:s;-1!==s&&(this.bufferingTime=s)}push(e,t){const a=this.dataSourceMap[e];if(!this.checkVersion(a,t))return;-1===this.startBufferingTime&&(console.log(`synchronizer buffering data for ${this.bufferingTime}ms..`),this.startBufferingTime=performance.now(),this.timeoutBuffering=setTimeout(()=>this.processData(),this.bufferingTime));let s=0;this.tsRun>0&&(s=this.tsRun-t.timeStamp),a.latency=s>a.latency?s:(a.latency+s)/2,a.dataBuffer.push(t)}reset(){console.log("reset synchronizer algo"),this.close();for(let e in this.dataSourceMap){const t=this.dataSourceMap[e];t.dataBuffer=[],t.startBufferingTime=-1,t.latency=0,t.status=i,t.version=void 0}this.tsRun=0,this.startBufferingTime=-1}processData(){if(!s(this.timeoutBuffering))return;let e,t=-1,a=performance.now();for(let a in this.dataSourceMap)e=this.dataSourceMap[a],e.dataBuffer.length>0&&(t=-1===t||e.dataBuffer[0].timeStamp<t?e.dataBuffer[0].timeStamp:t);this.interval=setInterval(()=>{for(;this.computeNextData(t,a););},this.timerResolution)}computeNextData(e,t){let a,s=null,i=0,r=0;for(let e in this.dataSourceMap)if(a=this.dataSourceMap[e],a.latency>0){let e=Math.min(a.latency,a.timeOut);i=e>i?e:i,r=a.latency<r?a.latency:r}i*=this.replaySpeed,r*=this.replaySpeed;const n=(performance.now()-t)*this.replaySpeed;this.tsRun=e+n;for(let t in this.dataSourceMap)if(a=this.dataSourceMap[t],a.dataBuffer.length>0){a.dataBuffer[0].timeStamp-e<=n-i&&(s=null===s?a:s.dataBuffer[0].timeStamp<a.dataBuffer[0].timeStamp?s:a)}if(null!==s){let e=s.dataBuffer.shift();return e["@latency"]=a.latency-r,this.onData(s.id,e),!0}return!1}addDataSource(e){this.dataSourceMap[e.id]={bufferingTime:e.bufferingTime,timeOut:e.timeOut||0,dataBuffer:[],startBufferingTime:-1,id:e.id,timedOut:!1,name:e.name||e.id,latency:0,status:i,version:void 0}}checkVersion(e,t){return!s(e.version)&&e.status!==i||(e.status!==i||e.version===t.version)&&void 0}onData(e,t){}setStatus(e,t){e in this.dataSourceMap&&(this.dataSourceMap[e].status=t,console.warn(t+" DataSource "+e+" from the synchronizer "))}close(){s(this.interval)&&(clearInterval(this.interval),this.interval=null),s(this.timeoutBuffering)&&(clearTimeout(this.timeoutBuffering),this.timeoutBuffering=null),console.log("Data synchronizer terminated successfully")}};const n="data",o="time",u="status",l="time-changed",d={};let f,c=!1,m=null;self.currentTime=-1;const p={};let h,g,S=null;function y(e){for(let t of e)v(t)}function v(e){f.addDataSource(e),d[e.id]=new BroadcastChannel("datasource-data-"+e.id),e.id in p||(p[e.id]=e)}async function B(e,t){self.currentTime=t.timeStamp,d[e].postMessage({values:[t],dataSourceId:e,type:n}),S.postMessage({timestamp:t.timeStamp,dataSourceId:e,type:o})}self.onmessage=e=>{let t=void 0;if("init"===e.data.message)f=new r(e.data.dataSources,e.data.replaySpeed,e.data.timerResolution),f.onData=B,c=!0,y(e.data.dataSources),g=e.data.dataTopic,h=e.data.timeTopic,a=g,s=h,console.log("listen on topic ",a),m=new BroadcastChannel(a),m.onmessage=async e=>{if(e.data.type===n)for(let t=0;t<e.data.values.length;t++)f.push(e.data.dataSourceId,{...e.data.values[t]});else if(e.data.type===u){const t=e.data.dataSourceId;f.setStatus(t,e.data.status),console.log(p[t].name+": status="+e.data.status),d[t].postMessage(e.data)}},S=new BroadcastChannel(s);else if("add"===e.data.message&&e.data.dataSources)y(e.data.dataSources);else if("current-time"===e.data.message)t={message:"current-time",data:self.currentTime};else if("reset"===e.data.message)null!==f&&f.reset(),S.postMessage({type:l});else if("replay-speed"===e.data.message)null!==f&&(f.replaySpeed=e.data.replaySpeed);else{if("data"!==e.data.message)return;null!==f&&f.push(e.data.dataSourceId,{data:e.data.data,timeStamp:e.data.timeStamp})}var a,s;self.postMessage({message:e.data.message,data:t,messageId:e.data.messageId})},self.onclose=function(){f.close(),console.log("Data Synchronizer has been terminated successfully")}}]);