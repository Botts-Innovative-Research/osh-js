!function(){"use strict";function e(e){return null!=e}function t(t,s="letiable"){if(!e(t))throw s+" must be defined";return t}Math.pow(2,53);const s="connected",n="disconnected",o="closed-error";var i=class{constructor(e,t){this.url=e,this.properties=t,this.id="DataConnector-"+"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),this.reconnectTimeout=12e4,this.status=n,this.reconnectionInterval=-1}checkAndClearReconnection(){-1!==this.reconnectionInterval&&(clearInterval(this.reconnectionInterval),this.reconnectionInterval=-1)}disconnect(){this.checkStatus(n),this.checkAndClearReconnection()}setUrl(e){this.url=e}getId(){return this.id}getUrl(){return this.url}setReconnectTimeout(e){this.reconnectTimeout=e}onReconnect(){return!0}connect(){}forceReconnect(){this.disconnect(),this.connect()}onChangeStatus(e){}checkStatus(e){e!==this.status&&(this.onChangeStatus(e),this.status=e)}onDisconnect(){}onConnect(){}},r=class extends i{constructor(e){super(e),this.interval=-1,this.lastReceiveTime=0}async connect(){this.init||(this.closed=!1,this.init=!0,this.ws=new WebSocket(this.getUrl()),this.ws.binaryType="arraybuffer",this.checkStatus("connecting"),console.warn("WebSocket stream connecting"),this.ws.onopen=function(e){this.checkAndClearReconnection(),this.checkStatus(s),console.warn("WebSocket stream connected")}.bind(this),this.ws.onmessage=function(e){this.lastReceiveTime=Date.now(),e.data.byteLength>0&&this.onMessage(e.data)}.bind(this),this.ws.onerror=function(e){console.error("WebSocket stream error"),this.checkStatus(o),this.init=!1,this.lastReceiveTime=-1,this.createReconnection()}.bind(this),this.ws.onclose=e=>{console.warn("WebSocket stream closed: ",e.reason,e.code),1e3===e.code||this.closed?this.checkStatus(n):(this.checkStatus(o),this.createReconnection())},-1!==this.reconnectionInterval&&(clearInterval(this.reconnectionInterval),this.reconnectionInterval=-1))}createReconnection(){!this.closed&&-1===this.reconnectionInterval&&this.onReconnect()&&(this.reconnectionInterval=setInterval(function(){let e=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||e>=this.reconnectTimeout)&&(console.warn("trying to reconnect",this.url),this.init=!1,this.connect())}.bind(this),this.reconnectTimeout))}disconnect(){super.disconnect(),this.init=!1,this.closed=!0,null!=this.ws&&this.ws.readyState!==WebSocket.CLOSED&&this.ws.close()}onMessage(e){}isConnected(){return null!=this.ws&&this.ws.readyState===WebSocket.OPEN}},c=class extends i{constructor(t,s){super(t),this.method="POST",this.responseType="arraybuffer",e(s)&&(s.method&&(this.method=s.method),s.responseType&&(this.responseType=s.responseType))}sendRequest(t,o){let i=this,r=new XMLHttpRequest;r.withCredentials=!0,r.timeout=6e4,null===t?(e(o)?r.open("GET",this.getUrl()+"?"+o,!0):r.open("GET",this.getUrl(),!0),r.responseType=this.responseType,r.onload=e=>{r.response&&i.onMessage(r.response),i.checkStatus(n)},r.ontimeout=e=>{console.log("Timeout"),i.checkStatus(n)},i.checkStatus(s),r.send(null)):(r.open("POST",this.getUrl(),!0),r.setRequestHeader("Content-Type","text/xml"),r.send(t),i.checkStatus(s),r.onreadystatechange=()=>{r.readyState<4||4===r.readyState&&(200===r.status&&r.status<300?i.onSuccess(r.responseText):i.onError(""),i.checkStatus(n))})}onError(e){}onSuccess(e){}connect(){this.sendRequest(null)}isConnected(){return!1}},a=class extends i{constructor(e){super(e),this.lastReceiveTime=-1,this.interval=-1,this.broadcastChannel=null}connect(){null===this.broadcastChannel&&(this.broadcastChannel=new BroadcastChannel(this.getUrl()),this.broadcastChannel.onmessage=e=>{this.lastReceiveTime=Date.now(),this.onMessage(e.data.data)},this.broadcastChannel.onerror=e=>{console.error("BroadcastChannel stream error: "+e),this.broadcastChannel.close(),this.init=!1,this.lastReceiveTime=-1,this.opened=!1},this.opened=!0,-1===this.interval&&(this.interval=setInterval(function(){let e=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||e>=this.reconnectTimeout)&&(console.warn(`trying to reconnect after ${this.reconnectTimeout} ..`),this.reconnect())}.bind(this),this.reconnectTimeout)))}disconnect(){this.fullDisconnect(!0)}fullDisconnect(e){null!=this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),e&&clearInterval(this.interval),this.opened=!1}reconnect(){this.onReconnect(),this.init&&this.fullDisconnect(!1),this.connect()}onMessage(e){}close(){this.disconnect()}isConnected(){return null!==this.broadcastChannel&&this.opened}};class h{constructor(e="undefined"){this.originalXml=e}setXml(e){this.originalXml=e}static get arrayNodeSet(){return new Set(["featureMember","offering","observableProperty","field","coordinate","item","quality","member","interval","AllowedValues/value"])}static get numericalNodeSet(){return new Set(["nilValue","paddingBytes-after","paddingBytes-before","byteLength","significantBits","bitLength","Time/value","Quantity/value","Count/value"])}toJson(){var e=this.originalXml,t={}.pos||0,s="<".charCodeAt(0),n=">".charCodeAt(0),o="-".charCodeAt(0),i="/".charCodeAt(0),r="!".charCodeAt(0),c="'".charCodeAt(0),a='"'.charCodeAt(0),l=h.arrayNodeSet,u=h.numericalNodeSet;function d(e){return l.has(e)}function p(){for(var s=t;-1==="\n\t>/= ".indexOf(e[t])&&e[t];)t++;return e.slice(s,t)}function f(e){var t=e.indexOf(":");return t>0?e.substring(t+1):e}var m=function h(){var l,m,v={};for(t++,v.type=f(p());e.charCodeAt(t)!==n&&e[t];){var g=e.charCodeAt(t);if(g>64&&g<91||g>96&&g<123){for(var b=p(),C=f(b),S=e.charCodeAt(t);S&&S!==c&&S!==a&&!(S>64&&S<91||S>96&&S<123)&&S!==n;)t++,S=e.charCodeAt(t);if(S===c||S===a){var x=(l=void 0,m=void 0,l=e[t],m=++t,t=e.indexOf(l,m),e.slice(m,t));if(-1===t)return v}else x=null,t--;b.startsWith("xmlns:")||(v[C]=x)}t++}return e.charCodeAt(t-1)!==i?(t++,function(c){for(;e[t];)if(e.charCodeAt(t)==s){if(e.charCodeAt(t+1)===i)return void((t=e.indexOf(">",t))+1&&(t+=1));if(e.charCodeAt(t+1)===r){if(e.charCodeAt(t+2)==o){for(;-1!==t&&(e.charCodeAt(t)!==n||e.charCodeAt(t-1)!=o||e.charCodeAt(t-2)!=o||-1==t);)t=e.indexOf(">",t+1);-1===t&&(t=e.length)}else for(t+=2;e.charCodeAt(t)!==n&&e[t];)t++;t++;continue}var a=h(),l=a.type;if("type"===l)continue;var p=l.charAt(0)==l.charAt(0).toLowerCase();if(p&&a.hasOwnProperty("value"))d(l)?(c.hasOwnProperty(l)||(c[l]=[]),c[l].push(a.value)):c[l]=a.value;else{if(p)for(var f in delete a.type,a)"object"==typeof a[f]&&"name"!==f&&(Object.assign(a,a[f]),delete a[f]);d(l)?(c.hasOwnProperty(l)||(c[l]=[]),c[l].push(a)):c[l]=a}}else{var m=(v=void 0,v=t,-2==(t=e.indexOf("<",t)-1)&&(t=e.length),e.slice(v,t+1));m.trim().length>0&&(u.has(c.type)?c.value=parseFloat(m):c.value=m),t++}var v}(v)):t++,v}();return m.pos=t,m}}var l=h;const u=new class{constructor(e){this.parser=e,this.connector=null,this.reconnectTimeout=1e4,this.values=[],this.version=-Number.MAX_SAFE_INTEGER}init(e,t,s){this.dataSourceId=s,null!==this.connector&&(this.connector.disconnect(),this.connector=null),this.broadcastChannel=new BroadcastChannel(t);const n=JSON.parse(e);this.handleProperties(n),this.createDataConnector(this.properties)}handleProperties(t){e(t.bufferingTime)&&(this.bufferingTime=t.bufferingTime),e(t.timeOut)&&(this.timeOut=t.timeOut),e(t.reconnectTimeout)&&(this.reconnectTimeout=t.reconnectTimeout),this.properties=t}createDataConnector(e){const t=this.parser.buildUrl(e);e.protocol.startsWith("ws")?this.connector=new r(t):e.protocol.startsWith("http")?(this.connector=new c(t),this.connector.responseType=e.responseType||"arraybuffer"):"topic"===e.protocol&&(this.connector=new a(t)),null!==this.connector&&(this.connector.setReconnectTimeout(this.reconnectTimeout),this.connector.onMessage=this.onMessage.bind(this),this.connector.onChangeStatus=this.onChangeStatus.bind(this))}setTopic(t){e(this.broadcastChannel)&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(t),this.topic=t}connect(){null!==this.connector&&this.connector.connect()}disconnect(){null!==this.connector&&this.connector.disconnect()}async onMessage(t){const s=await Promise.resolve(this.parser.parseData(t));if(Array.isArray(s))for(let t=0;t<s.length;t++)this.values.push({data:s[t],version:this.version}),e(this.batchSize)&&this.values.length>=this.batchSize&&this.flush();else this.values.push({data:s,version:this.version});this.isConnected()?e(this.batchSize)&&0!==this.values.length&&this.values.length>=this.batchSize&&this.flush():this.flushAll()}onChangeStatus(e){e===n&&this.flushAll(),this.broadcastChannel.postMessage({type:"status",status:e,dataSourceId:this.dataSourceId})}updateProperties(e){this.disconnect(),this.createDataConnector({...this.properties,...e}),this.version++,this.connect()}flushAll(){for(;this.values.length>0;)this.flush()}flush(){let t=this.values.length;e(this.batchSize)&&this.values.length>this.batchSize&&(t=this.batchSize),this.broadcastChannel.postMessage({dataSourceId:this.dataSourceId,type:"data",values:this.values.splice(0,t)})}isConnected(){return null!==this.connector&&this.connector.isConnected()}handleMessage(e,t){"init"===e.message?this.init(e.properties,e.topic,e.id):"connect"===e.message?this.connect():"disconnect"===e.message?this.disconnect():"topic"===e.message?this.setTopic(e.topic):"update-url"===e.message?this.updateProperties(e.data):"is-connected"===e.message&&t.postMessage({message:"is-connected",data:this.isConnected()})}}(new class extends class{buildUrl(t){let s="";if(s+=t.protocol+"://",s+=t.endpointUrl+"?",s+="service="+t.service,s+="&version=2.0&",t.responseFormat&&(s+="&responseFormat="+t.responseFormat),e(t.customUrlParams)&&Object.keys(t.customUrlParams).length>0){s+="&";for(let e in t.customUrlParams)s+=e+"="+t.customUrlParams[e]+"&";s.endsWith("&")&&(s=s.slice(0,-1))}return s}}{async parseData(e){let s=new l(e);s.setXml(e);const n=s.toJson();return t(n.GetFeatureOfInterestResponse,"json.GetFeatureOfInterestResponse does not exist"),t(n.GetFeatureOfInterestResponse.featureMember,"json.GetFeatureOfInterestResponse.featureMember does not exist"),n.GetFeatureOfInterestResponse.featureMember}buildUrl(t){let s=super.buildUrl({responseFormat:"application/xml",...t});return s+="&request=GetFeatureOfInterest",e(t.procedureId)&&(s+="&procedure="+t.procedureId),s}});self.onmessage=e=>{u.handleMessage(e.data,self)}}();