!function(){"use strict";function t(t){return null!=t}Math.pow(2,53);const e="connected",s="disconnected",n="closed-error";var i=class{constructor(t,e){this.url=t,this.properties=e,this.id="DataConnector-"+"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})),this.reconnectTimeout=12e4,this.status=s,this.reconnectionInterval=-1}checkAndClearReconnection(){-1!==this.reconnectionInterval&&(clearInterval(this.reconnectionInterval),this.reconnectionInterval=-1)}disconnect(){this.checkStatus(s),this.checkAndClearReconnection()}setUrl(t){this.url=t}getId(){return this.id}getUrl(){return this.url}setReconnectTimeout(t){this.reconnectTimeout=t}onReconnect(){return!0}connect(){}forceReconnect(){this.disconnect(),this.connect()}onChangeStatus(t){}checkStatus(t){t!==this.status&&(this.onChangeStatus(t),this.status=t)}onDisconnect(){}onConnect(){}},o=class extends i{constructor(t){super(t),this.interval=-1,this.lastReceiveTime=0}async connect(){this.init||(this.closed=!1,this.init=!0,this.ws=new WebSocket(this.getUrl()),this.ws.binaryType="arraybuffer",this.checkStatus("connecting"),console.warn("WebSocket stream connecting"),this.ws.onopen=function(t){this.checkAndClearReconnection(),this.checkStatus(e),console.warn("WebSocket stream connected")}.bind(this),this.ws.onmessage=function(t){this.lastReceiveTime=Date.now(),t.data.byteLength>0&&this.onMessage(t.data)}.bind(this),this.ws.onerror=function(t){console.error("WebSocket stream error"),this.checkStatus(n),this.init=!1,this.lastReceiveTime=-1,this.createReconnection()}.bind(this),this.ws.onclose=t=>{console.warn("WebSocket stream closed: ",t.reason,t.code),1e3===t.code||this.closed?this.checkStatus(s):(this.checkStatus(n),this.createReconnection())},-1!==this.reconnectionInterval&&(clearInterval(this.reconnectionInterval),this.reconnectionInterval=-1))}createReconnection(){!this.closed&&-1===this.reconnectionInterval&&this.onReconnect()&&(this.reconnectionInterval=setInterval(function(){let t=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||t>=this.reconnectTimeout)&&(console.warn("trying to reconnect",this.url),this.init=!1,this.connect())}.bind(this),this.reconnectTimeout))}disconnect(){super.disconnect(),this.init=!1,this.closed=!0,null!=this.ws&&this.ws.readyState!==WebSocket.CLOSED&&this.ws.close()}onMessage(t){}isConnected(){return null!=this.ws&&this.ws.readyState===WebSocket.OPEN}},a=class extends i{constructor(e,s){super(e),this.method="POST",this.responseType="arraybuffer",t(s)&&(s.method&&(this.method=s.method),s.responseType&&(this.responseType=s.responseType))}sendRequest(n,i){let o=this,a=new XMLHttpRequest;a.withCredentials=!0,a.timeout=6e4,null===n?(t(i)?a.open("GET",this.getUrl()+"?"+i,!0):a.open("GET",this.getUrl(),!0),a.responseType=this.responseType,a.onload=t=>{a.response&&o.onMessage(a.response),o.checkStatus(s)},a.ontimeout=t=>{console.log("Timeout"),o.checkStatus(s)},o.checkStatus(e),a.send(null)):(a.open("POST",this.getUrl(),!0),a.setRequestHeader("Content-Type","text/xml"),a.send(n),o.checkStatus(e),a.onreadystatechange=()=>{a.readyState<4||4===a.readyState&&(200===a.status&&a.status<300?o.onSuccess(a.responseText):o.onError(""),o.checkStatus(s))})}onError(t){}onSuccess(t){}connect(){this.sendRequest(null)}isConnected(){return!1}},r=class extends i{constructor(t){super(t),this.lastReceiveTime=-1,this.interval=-1,this.broadcastChannel=null}connect(){null===this.broadcastChannel&&(this.broadcastChannel=new BroadcastChannel(this.getUrl()),this.broadcastChannel.onmessage=t=>{this.lastReceiveTime=Date.now(),this.onMessage(t.data.data)},this.broadcastChannel.onerror=t=>{console.error("BroadcastChannel stream error: "+t),this.broadcastChannel.close(),this.init=!1,this.lastReceiveTime=-1,this.opened=!1},this.opened=!0,-1===this.interval&&(this.interval=setInterval(function(){let t=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||t>=this.reconnectTimeout)&&(console.warn(`trying to reconnect after ${this.reconnectTimeout} ..`),this.reconnect())}.bind(this),this.reconnectTimeout)))}disconnect(){this.fullDisconnect(!0)}fullDisconnect(t){null!=this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),t&&clearInterval(this.interval),this.opened=!1}reconnect(){this.onReconnect(),this.init&&this.fullDisconnect(!1),this.connect()}onMessage(t){}close(){this.disconnect()}isConnected(){return null!==this.broadcastChannel&&this.opened}};const c=new class extends class{constructor(t){this.parser=t,this.connector=null,this.reconnectTimeout=1e4,this.values=[],this.version=-Number.MAX_SAFE_INTEGER}init(t,e,s){this.dataSourceId=s,null!==this.connector&&(this.connector.disconnect(),this.connector=null),this.broadcastChannel=new BroadcastChannel(e);const n=JSON.parse(t);this.handleProperties(n),this.createDataConnector(this.properties)}handleProperties(e){t(e.bufferingTime)&&(this.bufferingTime=e.bufferingTime),t(e.timeOut)&&(this.timeOut=e.timeOut),t(e.reconnectTimeout)&&(this.reconnectTimeout=e.reconnectTimeout),this.properties=e}createDataConnector(t){const e=this.parser.buildUrl(t);t.protocol.startsWith("ws")?this.connector=new o(e):t.protocol.startsWith("http")?(this.connector=new a(e),this.connector.responseType=t.responseType||"arraybuffer"):"topic"===t.protocol&&(this.connector=new r(e)),null!==this.connector&&(this.connector.setReconnectTimeout(this.reconnectTimeout),this.connector.onMessage=this.onMessage.bind(this),this.connector.onChangeStatus=this.onChangeStatus.bind(this))}setTopic(e){t(this.broadcastChannel)&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(e),this.topic=e}connect(){null!==this.connector&&this.connector.connect()}disconnect(){null!==this.connector&&this.connector.disconnect()}async onMessage(e){const s=await Promise.resolve(this.parser.parseData(e));if(Array.isArray(s))for(let e=0;e<s.length;e++)this.values.push({data:s[e],version:this.version}),t(this.batchSize)&&this.values.length>=this.batchSize&&this.flush();else this.values.push({data:s,version:this.version});this.isConnected()?t(this.batchSize)&&0!==this.values.length&&this.values.length>=this.batchSize&&this.flush():this.flushAll()}onChangeStatus(t){t===s&&this.flushAll(),this.broadcastChannel.postMessage({type:"status",status:t,dataSourceId:this.dataSourceId})}updateProperties(t){this.disconnect(),this.createDataConnector({...this.properties,...t}),this.version++,this.connect()}flushAll(){for(;this.values.length>0;)this.flush()}flush(){let e=this.values.length;t(this.batchSize)&&this.values.length>this.batchSize&&(e=this.batchSize),this.broadcastChannel.postMessage({dataSourceId:this.dataSourceId,type:"data",values:this.values.splice(0,e)})}isConnected(){return null!==this.connector&&this.connector.isConnected()}handleMessage(t,e){"init"===t.message?this.init(t.properties,t.topic,t.id):"connect"===t.message?this.connect():"disconnect"===t.message?this.disconnect():"topic"===t.message?this.setTopic(t.topic):"update-url"===t.message?this.updateProperties(t.data):"is-connected"===t.message&&e.postMessage({message:"is-connected",data:this.isConnected()})}}{constructor(t){super(t),this.lastTimeStamp=null,this.lastStartTime="now",this.timeShift=0,this.timeBroadcastChannel=null}createDataConnector(e){super.createDataConnector({...e,timeShift:this.timeShift});const s=this.parser.lastStartTime;this.connector.onReconnect=()=>("now"!==s&&this.connector.setUrl(this.parser.buildUrl({...e,lastTimeStamp:t(this.lastTimeStamp)?new Date(this.lastTimeStamp).toISOString():e.startTime})),!0)}handleProperties(e){super.handleProperties(e),t(e.timeShift)&&(this.timeShift=e.timeShift),"now"===e.startTime?this.batchSize=1:(t(e.replaySpeed)&&(t(e.batchSize)||(this.batchSize=1)),t(e.batchSize)&&(this.batchSize=e.batchSize))}async onMessage(e){const s=await Promise.resolve(this.parser.parseTimeStamp(e)+this.timeShift),n=await Promise.resolve(this.parser.parseData(e));if(Array.isArray(n))for(let t=0;t<n.length;t++)this.values.push({data:n[t],timeStamp:s,version:this.version});else this.values.push({data:n,timeStamp:s,version:this.version});this.lastTimeStamp=s,("now"===this.parser.lastStartTime||t(this.batchSize)&&this.values.length>=this.batchSize)&&(this.flush(),null!==this.timeBroadcastChannel&&this.timeBroadcastChannel.postMessage({timestamp:this.lastTimeStamp,type:"time"}))}getLastTimeStamp(){return this.lastTimeStamp}updateProperties(e){this.disconnect(),this.timeBroadcastChannel.postMessage({dataSourceId:this.dataSourceId,type:"time-changed"});let s=new Date(this.lastTimeStamp).toISOString();e.hasOwnProperty("startTime")?s=e.startTime:"now"===this.properties.startTime&&(s="now"),this.version++,this.createDataConnector({...this.properties,...e,lastTimeStamp:s}),t(e)&&t(e.reconnect)&&e.reconnect&&this.connect()}handleMessage(t,e){if(super.handleMessage(t,e),"last-timestamp"===t.message){const t=this.getLastTimeStamp();e.postMessage({message:"last-timestamp",data:t})}else"topic"===t.message&&(this.setTimeTopic(t.timeTopic),super.setTopic(t.topic))}setTimeTopic(t){null!==this.timeBroadcastChannel&&this.timeBroadcastChannel.close(),this.timeBroadcastChannel=new BroadcastChannel(t)}}(new class extends class extends class{buildUrl(e){let s="";if(s+=e.protocol+"://",s+=e.endpointUrl+"?",s+="service="+e.service,s+="&version=2.0&",e.responseFormat&&(s+="&responseFormat="+e.responseFormat),t(e.customUrlParams)&&Object.keys(e.customUrlParams).length>0){s+="&";for(let t in e.customUrlParams)s+=t+"="+e.customUrlParams[t]+"&";s.endsWith("&")&&(s=s.slice(0,-1))}return s}}{buildUrl(e){let s=super.buildUrl(e);s+="&request=GetResult",s+="&offering="+e.offeringID,s+="&observedProperty="+e.observedProperty;const n=t(e.lastTimeStamp)?e.lastTimeStamp:e.startTime;return this.lastStartTime=e.startTime,s+="&temporalFilter=phenomenonTime,"+n+"/"+e.endTime,e.replaySpeed&&(s+="&replaySpeed="+e.replaySpeed),s}}{parseTimeStamp(t){let e=String.fromCharCode.apply(null,new Uint8Array(t));return new Date(JSON.parse(e).time).getTime()}parseData(t){let e=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(t))),s={};for(let t in e)"time"!==t&&(s[t]=e[t]);return s}buildUrl(t){let e=super.buildUrl({...t,responseFormat:"application/json"});return t.foiId&&""!==t.of&&(e+="&featureOfInterest="+t.foiId),e}});self.onmessage=t=>{c.handleMessage(t.data,self)}}();