!function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);Math.pow(2,53);function n(e){return null!=e}function i(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var o=class{buildUrl(e){let t="";if(t+=e.protocol+"://",t+=e.endpointUrl+"?",t+="service="+e.service,t+="&version=2.0&",e.responseFormat&&(t+="&responseFormat="+e.responseFormat),n(e.customUrlParams)&&Object.keys(e.customUrlParams).length>0){t+="&";for(let s in e.customUrlParams)t+=s+"="+e.customUrlParams[s]+"&";t.endsWith("&")&&(t=t.slice(0,-1))}return t}};var r=class extends o{buildUrl(e){let t=super.buildUrl(e);t+="&request=GetResult",t+="&offering="+e.offeringID,t+="&observedProperty="+e.observedProperty;const s=n(e.lastTimeStamp)?e.lastTimeStamp:e.startTime;return this.lastStartTime=e.startTime,t+="&temporalFilter=phenomenonTime,"+s+"/"+e.endTime,e.replaySpeed&&(t+="&replaySpeed="+e.replaySpeed),t}};var a=class extends r{parseTimeStamp(e){let t=String.fromCharCode.apply(null,new Uint8Array(e));return new Date(JSON.parse(t).time).getTime()}parseData(e){let t=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e))),s={};for(let e in t)"time"!==e&&(s[e]=t[e]);return s}buildUrl(e){let t=super.buildUrl({...e,responseFormat:"application/json"});return e.foiId&&""!==e.of&&(t+="&featureOfInterest="+e.foiId),t}};const c="connecting",h="connected",l="disconnected",u="closed-error";var d=class{constructor(e,t){this.url=e,this.properties=t,this.id="DataConnector-"+i(),this.reconnectTimeout=12e4,this.status=l,this.reconnectionInterval=-1}checkAndClearReconnection(){-1!==this.reconnectionInterval&&(clearInterval(this.reconnectionInterval),this.reconnectionInterval=-1)}disconnect(){this.checkStatus(l),this.checkAndClearReconnection()}setUrl(e){this.url=e}getId(){return this.id}getUrl(){return this.url}setReconnectTimeout(e){this.reconnectTimeout=e}onReconnect(){return!0}connect(){}forceReconnect(){this.disconnect(),this.connect()}onChangeStatus(e){}checkStatus(e){e!==this.status&&(this.onChangeStatus(e),this.status=e)}onDisconnect(){}onConnect(){}};var p=class extends d{constructor(e){super(e),this.interval=-1,this.lastReceiveTime=0}async connect(){this.init||(this.closed=!1,this.init=!0,this.ws=new WebSocket(this.getUrl()),this.ws.binaryType="arraybuffer",this.checkStatus(c),console.warn("WebSocket stream connecting"),this.ws.onopen=function(e){this.checkAndClearReconnection(),this.checkStatus(h),console.warn("WebSocket stream connected")}.bind(this),this.ws.onmessage=function(e){this.lastReceiveTime=Date.now(),e.data.byteLength>0&&this.onMessage(e.data)}.bind(this),this.ws.onerror=function(e){console.error("WebSocket stream error"),this.checkStatus(u),this.init=!1,this.lastReceiveTime=-1,this.createReconnection()}.bind(this),this.ws.onclose=e=>{console.warn("WebSocket stream closed: ",e.reason,e.code),1e3===e.code||this.closed?this.checkStatus(l):(this.checkStatus(u),this.createReconnection())},-1!==this.reconnectionInterval&&(clearInterval(this.reconnectionInterval),this.reconnectionInterval=-1))}createReconnection(){!this.closed&&-1===this.reconnectionInterval&&this.onReconnect()&&(this.reconnectionInterval=setInterval(function(){let e=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||e>=this.reconnectTimeout)&&(console.warn("trying to reconnect",this.url),this.init=!1,this.connect())}.bind(this),this.reconnectTimeout))}disconnect(){super.disconnect(),this.init=!1,this.closed=!0,null!=this.ws&&this.ws.readyState!==WebSocket.CLOSED&&this.ws.close()}onMessage(e){}isConnected(){return null!=this.ws&&this.ws.readyState===WebSocket.OPEN}};var m=class extends d{constructor(e,t){super(e),this.method="POST",this.responseType="arraybuffer",n(t)&&(t.method&&(this.method=t.method),t.responseType&&(this.responseType=t.responseType))}sendRequest(e,t){let s=this,i=new XMLHttpRequest;i.withCredentials=!0,i.timeout=6e4,null===e?(n(t)?i.open("GET",this.getUrl()+"?"+t,!0):i.open("GET",this.getUrl(),!0),i.responseType=this.responseType,i.onload=e=>{i.response&&s.onMessage(i.response),s.checkStatus(l)},i.ontimeout=e=>{console.log("Timeout"),s.checkStatus(l)},s.checkStatus(h),i.send(null)):(i.open("POST",this.getUrl(),!0),i.setRequestHeader("Content-Type","text/xml"),i.send(e),s.checkStatus(h),i.onreadystatechange=()=>{i.readyState<4||4===i.readyState&&(200===i.status&&i.status<300?s.onSuccess(i.responseText):s.onError(""),s.checkStatus(l))})}onError(e){}onSuccess(e){}connect(){this.sendRequest(null)}isConnected(){return!1}};var S=class extends d{constructor(e){super(e),this.lastReceiveTime=-1,this.interval=-1,this.broadcastChannel=null}connect(){null===this.broadcastChannel&&(this.broadcastChannel=new BroadcastChannel(this.getUrl()),this.broadcastChannel.onmessage=e=>{this.lastReceiveTime=Date.now(),this.onMessage(e.data.data)},this.broadcastChannel.onerror=e=>{console.error("BroadcastChannel stream error: "+e),this.broadcastChannel.close(),this.init=!1,this.lastReceiveTime=-1,this.opened=!1},this.opened=!0,-1===this.interval&&(this.interval=setInterval(function(){let e=Date.now()-this.lastReceiveTime;(-1===this.lastReceiveTime||e>=this.reconnectTimeout)&&(console.warn(`trying to reconnect after ${this.reconnectTimeout} ..`),this.reconnect())}.bind(this),this.reconnectTimeout)))}disconnect(){this.fullDisconnect(!0)}fullDisconnect(e){null!=this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),e&&clearInterval(this.interval),this.opened=!1}reconnect(){this.onReconnect(),this.init&&this.fullDisconnect(!1),this.connect()}onMessage(e){}close(){this.disconnect()}isConnected(){return null!==this.broadcastChannel&&this.opened}};const f="data",T="status",g="time-changed";var v=class{constructor(e){this.parser=e,this.connector=null,this.reconnectTimeout=1e4,this.values=[],this.version=-Number.MAX_SAFE_INTEGER}init(e,t,s){this.dataSourceId=s,null!==this.connector&&(this.connector.disconnect(),this.connector=null),this.broadcastChannel=new BroadcastChannel(t);const n=JSON.parse(e);this.handleProperties(n),this.createDataConnector(this.properties)}handleProperties(e){n(e.bufferingTime)&&(this.bufferingTime=e.bufferingTime),n(e.timeOut)&&(this.timeOut=e.timeOut),n(e.reconnectTimeout)&&(this.reconnectTimeout=e.reconnectTimeout),this.properties=e}createDataConnector(e){const t=this.parser.buildUrl(e);e.protocol.startsWith("ws")?this.connector=new p(t):e.protocol.startsWith("http")?(this.connector=new m(t),this.connector.responseType=e.responseType||"arraybuffer"):"topic"===e.protocol&&(this.connector=new S(t)),null!==this.connector&&(this.connector.setReconnectTimeout(this.reconnectTimeout),this.connector.onMessage=this.onMessage.bind(this),this.connector.onChangeStatus=this.onChangeStatus.bind(this))}setTopic(e){n(this.broadcastChannel)&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(e),this.topic=e}connect(){null!==this.connector&&this.connector.connect()}disconnect(){null!==this.connector&&this.connector.disconnect()}async onMessage(e){const t=await Promise.resolve(this.parser.parseData(e));if(Array.isArray(t))for(let e=0;e<t.length;e++)this.values.push({data:t[e],version:this.version}),n(this.batchSize)&&this.values.length>=this.batchSize&&this.flush();else this.values.push({data:t,version:this.version});this.isConnected()?n(this.batchSize)&&0!==this.values.length&&this.values.length>=this.batchSize&&this.flush():this.flushAll()}onChangeStatus(e){e===l&&this.flushAll(),this.broadcastChannel.postMessage({type:T,status:e,dataSourceId:this.dataSourceId})}updateProperties(e){this.disconnect(),this.createDataConnector({...this.properties,...e}),this.version++,this.connect()}flushAll(){for(;this.values.length>0;)this.flush()}flush(){let e=this.values.length;n(this.batchSize)&&this.values.length>this.batchSize&&(e=this.batchSize),this.broadcastChannel.postMessage({dataSourceId:this.dataSourceId,type:f,values:this.values.splice(0,e)})}isConnected(){return null!==this.connector&&this.connector.isConnected()}handleMessage(e,t){"init"===e.message?this.init(e.properties,e.topic,e.id):"connect"===e.message?this.connect():"disconnect"===e.message?this.disconnect():"topic"===e.message?this.setTopic(e.topic):"update-url"===e.message?this.updateProperties(e.data):"is-connected"===e.message&&t.postMessage({message:"is-connected",data:this.isConnected()})}};const b=new class extends v{constructor(e){super(e),this.lastTimeStamp=null,this.lastStartTime="now",this.timeShift=0,this.timeBroadcastChannel=null}createDataConnector(e){super.createDataConnector({...e,timeShift:this.timeShift});const t=this.parser.lastStartTime;this.connector.onReconnect=()=>("now"!==t&&this.connector.setUrl(this.parser.buildUrl({...e,lastTimeStamp:n(this.lastTimeStamp)?new Date(this.lastTimeStamp).toISOString():e.startTime})),!0)}handleProperties(e){super.handleProperties(e),n(e.timeShift)&&(this.timeShift=e.timeShift),"now"===e.startTime?this.batchSize=1:(n(e.replaySpeed)&&(n(e.batchSize)||(this.batchSize=1)),n(e.batchSize)&&(this.batchSize=e.batchSize))}async onMessage(e){const t=await Promise.resolve(this.parser.parseTimeStamp(e)+this.timeShift),s=await Promise.resolve(this.parser.parseData(e));if(Array.isArray(s))for(let e=0;e<s.length;e++)this.values.push({data:s[e],timeStamp:t,version:this.version});else this.values.push({data:s,timeStamp:t,version:this.version});this.lastTimeStamp=t,("now"===this.parser.lastStartTime||n(this.batchSize)&&this.values.length>=this.batchSize)&&(this.flush(),null!==this.timeBroadcastChannel&&this.timeBroadcastChannel.postMessage({timestamp:this.lastTimeStamp}))}getLastTimeStamp(){return this.lastTimeStamp}updateProperties(e){this.disconnect(),this.timeBroadcastChannel.postMessage({dataSourceId:this.dataSourceId,type:g});let t=new Date(this.lastTimeStamp).toISOString();e.hasOwnProperty("startTime")?t=e.startTime:"now"===this.properties.startTime&&(t="now"),this.version++,this.createDataConnector({...this.properties,...e,lastTimeStamp:t}),n(e)&&n(e.reconnect)&&e.reconnect&&this.connect()}handleMessage(e,t){if(super.handleMessage(e,t),"last-timestamp"===e.message){const e=this.getLastTimeStamp();t.postMessage({message:"last-timestamp",data:e})}else"topic"===e.message&&(this.setTimeTopic(e.timeTopic),super.setTopic(e.topic))}setTimeTopic(e){null!==this.timeBroadcastChannel&&this.timeBroadcastChannel.close(),this.timeBroadcastChannel=new BroadcastChannel(e)}}(new a);self.onmessage=e=>{b.handleMessage(e.data,self)}}]);
//# sourceMappingURL=WorkerName.4769e2aa36f71ae23b0e.js.map